const fs = require('fs').promises;
const path = require('path');
const mongoose = require('mongoose');
require('dotenv').config();

const Club = require('../models/Club');

/**
 * Fix Script: Sync externalLinks from clubs.json to MongoDB
 * 
 * è¯»å– public/data/clubs.json ä¸­çš„ externalLinks æ•°æ®ï¼Œ
 * å¹¶æ›´æ–°åˆ°å·²å­˜åœ¨çš„ Club è®°å½•ä¸­
 */

async function fixExternalLinks() {
  try {
    // è¿æ¥æ•°æ®åº“
    await mongoose.connect(process.env.MONGODB_URI);
    console.log('âœ… Connected to MongoDB');

    // è¯»å– clubs.json
    const clubsJsonPath = path.join(__dirname, '../../public/data/clubs.json');
    const data = await fs.readFile(clubsJsonPath, 'utf8');
    const jsonClubs = JSON.parse(data);

    console.log(`ğŸ“„ Found ${jsonClubs.length} clubs in clubs.json\n`);

    let updated = 0;
    let skipped = 0;
    let notFound = 0;

    // éå† JSON ä¸­çš„æ¯ä¸ªç¤¾å›¢
    for (const jsonClub of jsonClubs) {
      try {
        // ä½¿ç”¨ ID æŸ¥æ‰¾æ•°æ®åº“ä¸­çš„ç¤¾å›¢
        const dbClub = await Club.findById(jsonClub.id);

        if (!dbClub) {
          console.log(`  âš ï¸  Not found in DB: ${jsonClub.name} (ID: ${jsonClub.id})`);
          notFound++;
          continue;
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        const hasExternalLinks = jsonClub.externalLinks && jsonClub.externalLinks.length > 0;
        const dbHasLinks = dbClub.externalLinks && dbClub.externalLinks.length > 0;
        
        // æ„å»ºæ–°çš„åæ ‡æ•°ç»„ [lng, lat]
        const newCoordinates = jsonClub.coordinates || [jsonClub.longitude, jsonClub.latitude];

        // å¦‚æœæ•°æ®ä¸åŒï¼Œæ›´æ–°æ•°æ®åº“
        if (hasExternalLinks && !dbHasLinks) {
          dbClub.externalLinks = jsonClub.externalLinks;
          dbClub.coordinates = newCoordinates;
          await dbClub.save();
          updated++;
          console.log(`  âœ“ Updated: ${jsonClub.name}`);
          console.log(`    - Added ${jsonClub.externalLinks.length} external link(s)`);
        } else if (!hasExternalLinks && dbHasLinks) {
          console.log(`  âš ï¸  Skipped: ${jsonClub.name} (DB has links, JSON doesn't)`);
          skipped++;
        } else if (!hasExternalLinks && !dbHasLinks) {
          // ä¸¤è¾¹éƒ½æ²¡æœ‰å¤–é“¾ï¼Œä½†ä»è¦æ›´æ–°åæ ‡
          dbClub.coordinates = newCoordinates;
          await dbClub.save();
          updated++;
          console.log(`  âœ“ Updated: ${jsonClub.name} (coordinates only)`);
        } else {
          console.log(`  â„¹ï¸  Already synced: ${jsonClub.name}`);
          skipped++;
        }
      } catch (error) {
        console.error(`  âœ— Error processing ${jsonClub.name}:`, error.message);
      }
    }

    console.log('\n' + '='.repeat(60));
    console.log('Fix Summary:');
    console.log(`  âœ“ Updated: ${updated}`);
    console.log(`  âš ï¸  Skipped: ${skipped}`);
    console.log(`  âŒ Not found: ${notFound}`);
    console.log('='.repeat(60));

  } catch (error) {
    console.error('âŒ Fix failed:', error);
    process.exit(1);
  } finally {
    await mongoose.disconnect();
    console.log('\nâœ… Done');
    process.exit(0);
  }
}

fixExternalLinks();

